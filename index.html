<html><head><base href="https://websim.io/location/" />
    <meta charset="utf-8">
    <title>å¤šåœ‹å®¶åœ°å€æŸ¥è©¢èˆ‡ç·¨è¼¯ç³»çµ±ï¼ˆé›»è…¦ç¶²é ç‰ˆï¼‰</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
      /* ä¿ç•™åŸæœ‰çš„æ¨£å¼ */
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
      }
      .sidebar {
        width: 400px;
        background-color: #f0f0f0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        transition: width 0.3s;
      }
      .search-container {
        margin-bottom: 20px;
        background-color: #e6f3ff;
        padding: 15px;
        border-radius: 8px;
      }
      textarea {
        width: 100%;
        height: 100px;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        resize: vertical;
      }
      button, select, .file-upload {
        background-color: #4CAF50;
        color: white;
        padding: 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
        margin-bottom: 10px;
        height: 40px;
        line-height: 20px;
        width: 100%;
        text-align: center;
        font-size: 14px;
        box-sizing: border-box;
      }
      button:hover, select:hover, .file-upload:hover {
        background-color: #45a049;
      }
      #history, #importedData, #notFoundList, #favorites {
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
      }
      #history {
        background-color: #fff0f0;
      }
      #importedData {
        background-color: #f0fff0;
      }
      #notFoundList {
        background-color: #fff0ff;
      }
      #favorites {
        background-color: #ffffd0;
      }
      #history h3, #importedData h3, #notFoundList h3, #favorites h3 {
        margin-top: 0;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
      }
      tr:nth-child(even) {
        background-color: #f9f9f9;
      }
      tr:hover {
        background-color: #e0e0e0;
        cursor: pointer;
      }
      #map {
        flex-grow: 1;
        transition: width 0.3s;
      }
      #coordinates {
        position: absolute;
        bottom: 10px;
        left: 420px;
        background-color: rgba(255, 255, 255, 0.8);
        padding: 5px 10px;
        border-radius: 4px;
        z-index: 1000;
        transition: left 0.3s;
      }
      #csvFile {
        display: none;
      }
      .file-upload {
        display: inline-block;
      }
      #searchStats {
        margin-top: 10px;
        font-weight: bold;
      }
      .checkbox-column {
        width: 30px;
      }
      #countrySelect, #historyCountryFilter, #favoritesCountryFilter {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        height: 40px;
      }
      .edit-mode {
        background-color: #ffe6e6;
      }
      #editInstructions {
        display: none;
        margin-top: 10px;
        padding: 10px;
        background-color: #e6f7ff;
        border: 1px solid #91d5ff;
        border-radius: 4px;
      }
      #resizer {
        width: 10px;
        background-color: #ccc;
        cursor: col-resize;
        transition: background-color 0.3s;
      }
      #resizer:hover {
        background-color: #999;
      }
      #toggleSidebar {
        position: absolute;
        top: 10px;
        left: 410px;
        z-index: 1000;
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        transition: left 0.3s, background-color 0.3s;
      }
      #toggleSidebar:hover {
        background-color: #45a049;
      }
      .history-controls, .favorites-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-bottom: 10px;
      }
      .history-controls button, .favorites-controls button {
        padding: 5px 8px;
        font-size: 0.8em;
        height: 35px;
        width: auto;
        flex: 1;
        min-width: 80px;
      }
      #editActions {
        display: none;
        margin-top: 10px;
      }
      #editActions button {
        margin-right: 10px;
        height: 40px;
        width: auto;
      }
      #confirmEdit {
        background-color: #4CAF50;
      }
      #cancelEdit {
        background-color: #f44336;
      }
      #progressBar {
        width: 100%;
        height: 20px;
        background-color: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 10px;
      }
      #progressFill {
        width: 0%;
        height: 100%;
        background-color: #4CAF50;
        transition: width 0.3s ease;
      }
      #progressText {
        text-align: center;
        margin-top: 5px;
        font-weight: bold;
      }
      .star-icon {
        color: #ddd;
        cursor: pointer;
        font-size: 1.2em;
      }
      .star-icon.favorite {
        color: gold;
      }
      .network-status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-weight: bold;
      }
      .network-online {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .network-offline {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      .proxy-status {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 5px;
        margin: 5px 0;
        border-radius: 4px;
        font-size: 12px;
      }
      .toggle-btn {
        cursor: pointer;
        font-size: 0.9em;
        color: #666;
        margin-left: 5px;
      }
      .section-content {
        display: none;
        margin-top: 10px;
      }
      .section-content.active {
        display: block;
      }
      .distance-label {
        background-color: white;
        padding: 5px;
        border: 2px solid red;
        border-radius: 5px;
        font-weight: bold;
      }
      .distance-map-highlight { color: #d00; font-weight: bold; font-size: 1.3em; }
    </style>
    </head>
    <body>
      <div class="sidebar" id="sidebar">
        <div class="search-container">
          <div id="networkStatus" class="network-status network-online">
            ğŸŒ ç¶²çµ¡ç‹€æ…‹: åœ¨ç·š
          </div>
          <div id="proxyStatus" class="proxy-status" style="display: none;">
            ğŸ”„ ä½¿ç”¨ä»£ç†æ¨¡å¼
          </div>
          <select id="countrySelect">
            <option value="">é¸æ“‡åœ‹å®¶ï¼ˆå¯é¸ï¼‰</option>
            <option value="tw">å°ç£</option>
            <option value="jp">æ—¥æœ¬</option>
            <option value="kr">éŸ“åœ‹</option>
            <option value="us">ç¾åœ‹</option>
            <option value="ca">åŠ æ‹¿å¤§</option>
            <option value="gb">è‹±åœ‹</option>
            <option value="fr">æ³•åœ‹</option>
            <option value="de">å¾·åœ‹</option>
            <option value="it">ç¾©å¤§åˆ©</option>
            <option value="es">è¥¿ç­ç‰™</option>
            <option value="au">æ¾³æ´²</option>
            <option value="nz">ç´è¥¿è˜­</option>
          </select>
          <textarea id="locations" placeholder="è¼¸å…¥å¤šå€‹åœ°å€ï¼Œæ¯è¡Œä¸€å€‹&#10;ä¾‹å¦‚ï¼š&#10;å°åŒ—101&#10;æ±äº¬éµå¡”&#10;ç´ç´„æ™‚ä»£å»£å ´"></textarea>
          <button onclick="searchLocations()">æŸ¥è©¢</button>
          <button onclick="retryFailedQueries()" id="retryBtn" style="display: none; background-color: #ff9800;">é‡è©¦å¤±æ•—çš„æŸ¥è©¢</button>
          <div style="font-size: 12px; color: #666; margin-top: 5px;">
            ğŸ’¡ æç¤ºï¼šé¸æ“‡åœ‹å®¶å¯ä»¥æé«˜æŸ¥è©¢æº–ç¢ºæ€§ï¼Œä½†æœƒé™åˆ¶çµæœç¯„åœ
          </div>
          <label for="csvFile" class="file-upload">
            åŒ¯å…¥CSV
            <input type="file" id="csvFile" accept=".csv" onchange="importCSV(this)">
          </label>
          <button onclick="clearImportedData()">æ¸…ç©ºåŒ¯å…¥çš„CSVæ•¸æ“š</button>
        </div>
        <div id="progressBar">
          <div id="progressFill"></div>
        </div>
        <div id="progressText"></div>
        <div id="editInstructions">
          ç·¨è¼¯æ¨¡å¼å·²é–‹å•Ÿã€‚é»æ“Šæ­·å²è¨˜éŒ„æˆ–æˆ‘çš„æœ€æ„›é …ç›®ï¼Œç„¶å¾Œåœ¨åœ°åœ–ä¸Šé»æ“Šæ–°çš„ä½ç½®ä¾†æ›´æ–°GPSåæ¨™ã€‚
        </div>
        <div id="editActions">
          <button id="confirmEdit" onclick="confirmEdit()">ç¢ºå®šæ›´æ–°ä½ç½®</button>
          <button id="cancelEdit" onclick="cancelEdit()">å–æ¶ˆæ›´æ–°ä½ç½®</button>
        </div>
        <div id="searchStats"></div>
        <div id="errorLog" style="display: none; margin-top: 10px; padding: 10px; background-color: #ffe6e6; border: 1px solid #ff9999; border-radius: 4px;">
          <h4>éŒ¯èª¤æ—¥èªŒ</h4>
          <div id="errorMessages"></div>
        </div>
        <div id="importedData">
          <h3>åŒ¯å…¥çš„CSVæ•¸æ“š <span class="toggle-btn" onclick="toggleSection('importedData')">[-]</span></h3>
          <div class="section-content">
            <p id="fileName"></p>
            <table id="csvContent">
              <thead>
                <tr>
                  <th>åœ°é»åç¨±</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div id="history">
          <h3>æŸ¥è©¢æ­·å² <span class="toggle-btn" onclick="toggleSection('history')">[-]</span></h3>
          <div class="section-content">
            <div class="history-controls">
              <button onclick="deleteSelectedHistory()">åˆªé™¤é¸ä¸­æ­·å²</button>
              <button onclick="clearAllHistory()">æ¸…ç©ºæ‰€æœ‰æ­·å²</button>
              <button onclick="showAllHistoryOnMap()">é¡¯ç¤ºæ‰€æœ‰æ­·å²</button>
              <button onclick="exportHistoryToCSV()">åŒ¯å‡ºæ­·å²CSV</button>
              <button onclick="addAllHistoryToFavorites()">å…¨éƒ¨åŠ ç‚ºæœ€æ„›</button>
              <button id="editModeBtn" onclick="toggleEditMode()">ç·¨è¼¯æ¨¡å¼</button>
              <button id="addLocationBtn" onclick="enableAddLocationMode()">æ–°å¢åœ°é»æ¨¡å¼</button>
              <button id="distanceBtn" onclick="enableDistanceMode()">è·é›¢æ¸¬é‡æ¨¡å¼</button>
              <button id="rangeSearchBtn" onclick="enableRangeSearchMode()">ç¯„åœæœå°‹æ¨¡å¼</button>
            </div>
            <select id="historyCountryFilter" onchange="filterHistoryByCountry()">
              <option value="">é¡¯ç¤ºæ‰€æœ‰åœ‹å®¶</option>
              <option value="tw">å°ç£</option>
              <option value="jp">æ—¥æœ¬</option>
              <option value="kr">éŸ“åœ‹</option>
              <option value="us">ç¾åœ‹</option>
              <option value="ca">åŠ æ‹¿å¤§</option>
              <option value="gb">è‹±åœ‹</option>
              <option value="fr">æ³•åœ‹</option>
              <option value="it">ç¾©å¤§åˆ©</option>
              <option value="es">è¥¿ç­ç‰™</option>
              <option value="au">æ¾³æ´²</option>
              <option value="nz">ç´è¥¿è˜­</option>
            </select>
            <table id="historyList">
              <thead>
                <tr>
                  <th class="checkbox-column"><input type="checkbox" id="selectAll" onclick="toggleAllCheckboxes()"></th>
                  <th>ç·¨è™Ÿ</th>
                  <th>CSVåŸå§‹è³‡æ–™</th>
                  <th>åœ°é»åç¨±</th>
                  <th>ç·¯åº¦</th>
                  <th>ç¶“åº¦</th>
                  <th>åœ‹å®¶</th>
                  <th>æœ€æ„›</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div id="favorites">
          <h3>æˆ‘çš„æœ€æ„› <span class="toggle-btn" onclick="toggleSection('favorites')">[-]</span></h3>
          <div class="section-content">
            <div class="favorites-controls">
              <button onclick="deleteSelectedFavorites()">åˆªé™¤é¸ä¸­æœ€æ„›</button>
              <button onclick="clearAllFavorites()">æ¸…ç©ºæ‰€æœ‰æœ€æ„›</button>
              <button onclick="showAllFavoritesOnMap()">é¡¯ç¤ºæ‰€æœ‰æœ€æ„›</button>
            </div>
            <select id="favoritesCountryFilter" onchange="filterFavoritesByCountry()">
              <option value="">é¡¯ç¤ºæ‰€æœ‰åœ‹å®¶</option>
              <option value="tw">å°ç£</option>
              <option value="jp">æ—¥æœ¬</option>
              <option value="kr">éŸ“åœ‹</option>
              <option value="us">ç¾åœ‹</option>
              <option value="ca">åŠ æ‹¿å¤§</option>
              <option value="gb">è‹±åœ‹</option>
              <option value="fr">æ³•åœ‹</option>
              <option value="it">ç¾©å¤§åˆ©</option>
              <option value="es">è¥¿ç­ç‰™</option>
              <option value="au">æ¾³æ´²</option>
              <option value="nz">ç´è¥¿è˜­</option>
            </select>
            <table id="favoritesList">
              <thead>
                <tr>
                  <th class="checkbox-column"><input type="checkbox" id="selectAllFavorites" onclick="toggleAllFavoritesCheckboxes()"></th>
                  <th>ç·¨è™Ÿ</th>
                  <th>CSVåŸå§‹è³‡æ–™</th>
                  <th>åœ°é»åç¨±</th>
                  <th>ç·¯åº¦</th>
                  <th>ç¶“åº¦</th>
                  <th>åœ‹å®¶</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div id="notFoundList">
          <h3>æŸ¥è©¢ä¸åˆ°çš„åœ°é»</h3>
          <ul></ul>
        </div>
      </div>
      <div id="resizer"></div>
      <div id="map"></div>
      <div id="coordinates"></div>
      <button id="toggleSidebar" onclick="toggleSidebar()">éš±è—å´æ¬„</button>
    
      <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
      <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
      <script>
        // ç¶²çµ¡é…ç½®
        const PROXY_URLS = [
          'https://cors-anywhere.herokuapp.com/',
          'https://api.allorigins.win/raw?url=',
          'https://thingproxy.freeboard.io/fetch/'
        ];
        let currentProxyIndex = 0;
        let isOnline = navigator.onLine;
        let useProxy = false;

        // é›¢ç·šæ•¸æ“šåº«
        const offlineDatabase = {
          'å°åŒ—101': { lat: 25.0330, lng: 121.5654, name: 'å°åŒ—101', country: 'å°ç£' },
          'taipei': { lat: 25.0330, lng: 121.5654, name: 'Taipei', country: 'Taiwan' },
          'æ±äº¬éµå¡”': { lat: 35.6586, lng: 139.7454, name: 'æ±äº¬éµå¡”', country: 'æ—¥æœ¬' },
          'tokyo tower': { lat: 35.6586, lng: 139.7454, name: 'Tokyo Tower', country: 'Japan' },
          'ç´ç´„æ™‚ä»£å»£å ´': { lat: 40.7580, lng: -73.9855, name: 'ç´ç´„æ™‚ä»£å»£å ´', country: 'ç¾åœ‹' },
          'times square': { lat: 40.7580, lng: -73.9855, name: 'Times Square', country: 'USA' },
          'å·´é»éµå¡”': { lat: 48.8584, lng: 2.2945, name: 'å·´é»éµå¡”', country: 'æ³•åœ‹' },
          'eiffel tower': { lat: 48.8584, lng: 2.2945, name: 'Eiffel Tower', country: 'France' },
          'å€«æ•¦å¤§ç¬¨é˜': { lat: 51.4994, lng: -0.1245, name: 'å€«æ•¦å¤§ç¬¨é˜', country: 'è‹±åœ‹' },
          'big ben': { lat: 51.4994, lng: -0.1245, name: 'Big Ben', country: 'UK' }
        };

        // åˆå§‹åŒ–åœ°åœ–å’Œè®Šé‡
        let map = L.map('map').setView([23.5, 121], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        let markers = [];
        let geocoder = L.Control.Geocoder.nominatim();
        let history = JSON.parse(localStorage.getItem('searchHistory')) || [];
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
        const coordinatesDiv = document.getElementById('coordinates');
        const notFoundList = document.getElementById('notFoundList').getElementsByTagName('ul')[0];
        let editMode = false;
        let selectedHistoryIndex = -1;
        let selectedFavoriteIndex = -1;
        let sidebarVisible = true;
        let tempMarker = null;
        let originalLocation = null;
        let failedQueries = [];
        let addLocationMode = false; // æ–°å¢åœ°é»æ¨¡å¼
        let floatingAddMarker = null; // æ–°å¢åœ°é»æ™‚çš„æµ®å‹• marker
        let distanceMode = false; // è·é›¢æ¸¬é‡æ¨¡å¼
        let distanceMarkers = []; // è·é›¢æ¸¬é‡æ¨™è¨˜
        let distancePolyline = null; // è·é›¢æ¸¬é‡ç·šæ¢
        let floatingDistanceLine = null; // æµ®å‹•ç·šæ¢
        let floatingDistanceLabel = null; // æµ®å‹•è·é›¢æ¨™ç±¤
        let distanceStartLatLng = null; // è·é›¢æ¸¬é‡èµ·é»
        let rangeSearchMode = false; // ç¯„åœæœå°‹æ¨¡å¼
        let rangeCircle = null; // ç¯„åœæœå°‹åœ“åœˆ
        let rangeCenter = null; // ç¯„åœä¸­å¿ƒé»
        let floatingRangeCircle = null; // æµ®å‹•åœ“å½¢
        let floatingRangeLabel = null; // æµ®å‹•åŠå¾‘æ¨™ç±¤
        let rangeStep = 0; // 0:æœªé–‹å§‹, 1:å·²é¸ä¸­å¿ƒ, ç­‰å¾…åŠå¾‘
        let rangeCenterMarker = null; // ä¸­å¿ƒé»æ¨™è¨˜

        const countryNames = {
          'tw': 'å°ç£',
          'jp': 'æ—¥æœ¬',
          'kr': 'éŸ“åœ‹',
          'us': 'ç¾åœ‹',
          'ca': 'åŠ æ‹¿å¤§',
          'gb': 'è‹±åœ‹',
          'fr': 'æ³•åœ‹',
          'de': 'å¾·åœ‹',
          'it': 'ç¾©å¤§åˆ©',
          'es': 'è¥¿ç­ç‰™',
          'au': 'æ¾³æ´²',
          'nz': 'ç´è¥¿è˜­'
        };

        // ç¶²çµ¡ç‹€æ…‹ç›£æ§
        function updateNetworkStatus() {
          const statusDiv = document.getElementById('networkStatus');
          const proxyDiv = document.getElementById('proxyStatus');
          
          if (isOnline) {
            statusDiv.className = 'network-status network-online';
            statusDiv.innerHTML = 'ğŸŒ ç¶²çµ¡ç‹€æ…‹: åœ¨ç·š';
            proxyDiv.style.display = useProxy ? 'block' : 'none';
          } else {
            statusDiv.className = 'network-status network-offline';
            statusDiv.innerHTML = 'ğŸ“´ ç¶²çµ¡ç‹€æ…‹: é›¢ç·š (ä½¿ç”¨æœ¬åœ°æ•¸æ“š)';
            proxyDiv.style.display = 'none';
          }
        }

        // ä»£ç†è«‹æ±‚å‡½æ•¸
        async function fetchWithProxy(url, options = {}) {
          if (!isOnline) {
            throw new Error('ç¶²çµ¡é›¢ç·š');
          }

          // å…ˆå˜—è©¦ç›´æ¥è«‹æ±‚
          try {
            const response = await fetch(url, {
              ...options,
              headers: {
                'Accept': 'application/json',
                'User-Agent': 'AddressTestApp/1.0',
                ...options.headers
              }
            });
            
            if (response.ok) {
              return response;
            }
          } catch (error) {
            console.log('ç›´æ¥è«‹æ±‚å¤±æ•—ï¼Œå˜—è©¦ä»£ç†');
          }

          // ä½¿ç”¨ä»£ç†
          useProxy = true;
          updateNetworkStatus();
          
          for (let i = 0; i < PROXY_URLS.length; i++) {
            const proxyUrl = PROXY_URLS[(currentProxyIndex + i) % PROXY_URLS.length];
            try {
              const response = await fetch(proxyUrl + url, {
                ...options,
                headers: {
                  'Accept': 'application/json',
                  'Origin': window.location.origin,
                  ...options.headers
                }
              });
              
              if (response.ok) {
                currentProxyIndex = (currentProxyIndex + i) % PROXY_URLS.length;
                return response;
              }
            } catch (error) {
              console.log(`ä»£ç† ${i + 1} å¤±æ•—:`, error);
            }
          }
          
          throw new Error('æ‰€æœ‰ä»£ç†éƒ½å¤±æ•—');
        }

        // é›¢ç·šæŸ¥è©¢å‡½æ•¸
        function searchOffline(query) {
          const searchTerm = query.toLowerCase();
          
          // ç²¾ç¢ºåŒ¹é…
          if (offlineDatabase[searchTerm]) {
            return offlineDatabase[searchTerm];
          }
          
          // æ¨¡ç³ŠåŒ¹é…
          for (const [key, value] of Object.entries(offlineDatabase)) {
            if (key.includes(searchTerm) || value.name.toLowerCase().includes(searchTerm)) {
              return value;
            }
          }
          
          return null;
        }

        // æ ¼å¼åŒ–åœ°å€é¡¯ç¤ºï¼ˆå¾å¤§åˆ°å°ï¼‰
        function formatAddressDisplay(result) {
          const address = result.address;
          if (!address) return result.display_name;
          
          const addressParts = [];
          
          // æŒ‰ç…§å¾å¤§åˆ°å°çš„é †åºæ·»åŠ åœ°å€çµ„ä»¶
          if (address.country) addressParts.push(address.country);
          if (address.postcode) addressParts.push(address.postcode);
          if (address.state) addressParts.push(address.state);
          if (address.county) addressParts.push(address.county);
          if (address.city) addressParts.push(address.city);
          if (address.suburb) addressParts.push(address.suburb);
          if (address.neighbourhood) addressParts.push(address.neighbourhood);
          if (address.road) addressParts.push(address.road);
          if (address.house_number) addressParts.push(address.house_number);
          
          // å¦‚æœæ²’æœ‰è©³ç´°åœ°å€ä¿¡æ¯ï¼Œä½¿ç”¨åŸå§‹é¡¯ç¤ºåç¨±
          if (addressParts.length === 0) {
            return result.display_name;
          }
          
          return addressParts.join(',');
        }

        // ä¸»è¦æŸ¥è©¢å‡½æ•¸
        async function searchAddress(query, countryCode = '') {
          try {
            // æ§‹å»º API URL
            const params = new URLSearchParams({
              format: 'json',
              q: query,
              limit: '1',
              addressdetails: '1'
            });
            
            if (countryCode) {
              params.append('countrycodes', countryCode);
            }
            
            const url = `https://nominatim.openstreetmap.org/search?${params}`;
            
            const response = await fetchWithProxy(url);
            const data = await response.json();
            
            if (data && data.length > 0) {
              const result = data[0];
              return {
                name: formatAddressDisplay(result), // ä½¿ç”¨æ ¼å¼åŒ–åœ°å€
                lat: parseFloat(result.lat),
                lng: parseFloat(result.lon),
                country: result.address?.country_code || '',
                type: result.type,
                importance: result.importance
              };
            }
            
            return null;
          } catch (error) {
            console.log('åœ¨ç·šæŸ¥è©¢å¤±æ•—ï¼Œå˜—è©¦é›¢ç·šæŸ¥è©¢:', error);
            
            // é›¢ç·šæŸ¥è©¢
            const offlineResult = searchOffline(query);
            if (offlineResult) {
              return {
                name: offlineResult.name,
                lat: offlineResult.lat,
                lng: offlineResult.lng,
                country: offlineResult.country,
                type: 'offline',
                importance: 0.5
              };
            }
            
            throw error;
          }
        }

        // ä¿®æ”¹å¾Œçš„æŸ¥è©¢å‡½æ•¸
        async function searchLocations() {
          const queries = document.getElementById('locations').value.split('\n').filter(q => q.trim() !== '');
          const countryCode = document.getElementById('countrySelect').value;
          
          if (queries.length === 0) {
            alert('è«‹è¼¸å…¥è‡³å°‘ä¸€å€‹åœ°å€');
            return;
          }
          
          clearMarkers();
          notFoundList.innerHTML = '';
          failedQueries = [];
          
          const bounds = L.latLngBounds();
          let processedCount = 0;
          let foundCount = 0;
          let notFoundCount = 0;
          let errorCount = 0;

          updateProgress(0, queries.length);

          for (let i = 0; i < queries.length; i++) {
            const query = queries[i];
            
            try {
              const result = await searchAddress(query, countryCode);
              
              if (result) {
                foundCount++;
                const marker = L.marker([result.lat, result.lng]).addTo(map);
                markers.push(marker);
                marker.bindPopup(`${i + 1}. ${result.name}`);
                marker.on('click', function() { marker.openPopup(); highlightTableRowForLocation(result); });
                bounds.extend([result.lat, result.lng]);

                history.unshift({ 
                  name: result.name, 
                  latlng: { lat: result.lat, lng: result.lng }, 
                  countryCode: result.country,
                  originalQuery: query // ä¿å­˜åŸå§‹æŸ¥è©¢è³‡æ–™
                });
              } else {
                notFoundCount++;
                const li = document.createElement('li');
                li.textContent = `${i + 1}. ${query} (æŸ¥è©¢ä¸åˆ°çµæœ)`;
                notFoundList.appendChild(li);
                failedQueries.push({ query, index: i, reason: 'æŸ¥è©¢ä¸åˆ°çµæœ' });
              }
            } catch (error) {
              errorCount++;
              console.error(`æŸ¥è©¢åœ°å€æ™‚ç™¼ç”ŸéŒ¯èª¤: ${query}`, error);
              const li = document.createElement('li');
              li.textContent = `${i + 1}. ${query} (æŸ¥è©¢éŒ¯èª¤: ${error.message})`;
              li.style.color = 'red';
              notFoundList.appendChild(li);
              failedQueries.push({ query, index: i, reason: 'æŸ¥è©¢éŒ¯èª¤' });
            }
            
            processedCount++;
            updateProgress(processedCount, queries.length);
            
            // æ·»åŠ å»¶é²é¿å… API é™åˆ¶
            if (i < queries.length - 1) {
              await new Promise(resolve => setTimeout(resolve, 1000));
            }
          }

          finishSearch(bounds, queries.length, foundCount, notFoundCount, errorCount);
        }

        // å…¶ä»–å‡½æ•¸ä¿æŒä¸è®Š...
        function updateProgress(current, total) {
          const progressFill = document.getElementById('progressFill');
          const progressText = document.getElementById('progressText');
          const percentage = (current / total) * 100;
          progressFill.style.width = `${percentage}%`;
          progressText.textContent = `é€²åº¦: ${current}/${total} (${percentage.toFixed(1)}%)`;
        }

        function finishSearch(bounds, totalCount, foundCount, notFoundCount, errorCount) {
          if (markers.length > 0) {
            map.fitBounds(bounds);
          }
          // ç§»é™¤æ­·å²è¨˜éŒ„é™åˆ¶ï¼Œä¿ç•™æ‰€æœ‰æ­·å²
          // history = history.slice(0, 10);
          localStorage.setItem('searchHistory', JSON.stringify(history));
          updateHistoryList();
          updateSearchStats(totalCount, foundCount, notFoundCount, errorCount);
        }

        function updateSearchStats(totalCount, foundCount, notFoundCount, errorCount) {
          const statsDiv = document.getElementById('searchStats');
          let statsHTML = `æŸ¥è©¢ç¸½æ•¸: ${totalCount}<br>æŸ¥è©¢åˆ°: ${foundCount}<br>æŸ¥è©¢ä¸åˆ°: ${notFoundCount}`;
          if (errorCount > 0) {
            statsHTML += `<br>éŒ¯èª¤: ${errorCount}`;
            document.getElementById('errorLog').style.display = 'block';
          }
          statsDiv.innerHTML = statsHTML;
          
          const retryBtn = document.getElementById('retryBtn');
          if (failedQueries.length > 0) {
            retryBtn.style.display = 'block';
          } else {
            retryBtn.style.display = 'none';
          }
        }

        function retryFailedQueries() {
          if (failedQueries.length === 0) {
            alert('æ²’æœ‰å¤±æ•—çš„æŸ¥è©¢éœ€è¦é‡è©¦');
            return;
          }
          
          const queries = failedQueries.map(fq => fq.query);
          document.getElementById('locations').value = queries.join('\n');
          searchLocations();
        }

        // ä¿ç•™åŸæœ‰çš„å…¶ä»–å‡½æ•¸...
        function updateHistoryList(filter = '') {
          const historyList = document.getElementById('historyList').getElementsByTagName('tbody')[0];
          historyList.innerHTML = '';
          history.forEach((item, index) => {
            if (filter === '' || item.countryCode === filter) {
              const row = historyList.insertRow();
              const checkboxCell = row.insertCell(0);
              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.className = 'history-checkbox';
              checkboxCell.appendChild(checkbox);
              row.insertCell(1).textContent = index + 1;
              row.insertCell(2).textContent = item.originalQuery || '-';
              row.insertCell(3).textContent = item.name;
              row.insertCell(4).textContent = item.latlng.lat.toFixed(6);
              row.insertCell(5).textContent = item.latlng.lng.toFixed(6);
              row.insertCell(6).textContent = countryNames[item.countryCode] || 'æœªçŸ¥';
              const favoriteCell = row.insertCell(7);
              const starIcon = document.createElement('span');
              starIcon.className = 'star-icon' + (favorites.some(f => f.name === item.name) ? ' favorite' : '');
              starIcon.textContent = 'â˜…';
              starIcon.onclick = (e) => {
                e.stopPropagation();
                toggleFavorite(item);
              };
              favoriteCell.appendChild(starIcon);
              // é¡¯ç¤ºåœ°åœ–æ¨™èªŒ
              const mapIcon = document.createElement('span');
              mapIcon.textContent = markers.some(m => m.getLatLng().lat === item.latlng.lat && m.getLatLng().lng === item.latlng.lng) ? 'ğŸ“' : '';
              favoriteCell.appendChild(mapIcon);
              // æ–°å¢ï¼šcheckbox é¸ä¸­æ™‚è‡ªå‹•é¡¯ç¤º/ç§»é™¤åœ°åœ–æ¨™è¨˜
              checkbox.addEventListener('change', function() {
                if (checkbox.checked) {
                  // é¡¯ç¤ºè©²åœ°é»
                  const marker = L.marker(item.latlng).addTo(map);
                  marker.bindPopup(item.name);
                  marker.on('click', function() { marker.openPopup(); highlightTableRowForLocation(item); });
                  markers.push(marker);
                } else {
                  // ç§»é™¤è©²åœ°é»
                  const idx = markers.findIndex(m => m.getLatLng().lat === item.latlng.lat && m.getLatLng().lng === item.latlng.lng);
                  if (idx !== -1) {
                    map.removeLayer(markers[idx]);
                    markers.splice(idx, 1);
                  }
                }
              });
              row.onclick = (e) => {
                if (e.target.type !== 'checkbox' && e.target.className.indexOf('star-icon') === -1) {
                  if (editMode) {
                    selectHistoryItem(index, row);
                  } else {
                    showLocationFromHistory(index);
                  }
                }
              };
            }
          });
          updateFavoritesList();
        }

        function updateFavoritesList(filter = '') {
          const favoritesList = document.getElementById('favoritesList').getElementsByTagName('tbody')[0];
          favoritesList.innerHTML = '';
          favorites.forEach((item, index) => {
            if (filter === '' || item.countryCode === filter) {
              const row = favoritesList.insertRow();
              const checkboxCell = row.insertCell(0);
              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.className = 'favorite-checkbox';
              checkboxCell.appendChild(checkbox);
              row.insertCell(1).textContent = index + 1;
              row.insertCell(2).textContent = item.originalQuery || '-';
              row.insertCell(3).textContent = item.name;
              row.insertCell(4).textContent = item.latlng.lat.toFixed(6);
              row.insertCell(5).textContent = item.latlng.lng.toFixed(6);
              row.insertCell(6).textContent = countryNames[item.countryCode] || 'æœªçŸ¥';
              // é¡¯ç¤ºåœ°åœ–æ¨™èªŒ
              const mapIcon = document.createElement('span');
              mapIcon.textContent = markers.some(m => m.getLatLng().lat === item.latlng.lat && m.getLatLng().lng === item.latlng.lng) ? 'ğŸ“' : '';
              row.appendChild(mapIcon);
              // æ–°å¢ï¼šcheckbox é¸ä¸­æ™‚è‡ªå‹•é¡¯ç¤º/ç§»é™¤åœ°åœ–æ¨™è¨˜
              checkbox.addEventListener('change', function() {
                if (checkbox.checked) {
                  const marker = L.marker(item.latlng).addTo(map);
                  marker.bindPopup(item.name);
                  marker.on('click', function() { marker.openPopup(); highlightTableRowForLocation(item); });
                  markers.push(marker);
                } else {
                  const idx = markers.findIndex(m => m.getLatLng().lat === item.latlng.lat && m.getLatLng().lng === item.latlng.lng);
                  if (idx !== -1) {
                    map.removeLayer(markers[idx]);
                    markers.splice(idx, 1);
                  }
                }
              });
              row.onclick = (e) => {
                if (e.target.type !== 'checkbox') {
                  if (editMode) {
                    selectFavoriteItem(index, row);
                  } else {
                    showLocationFromFavorites(index);
                  }
                }
              };
            }
          });
        }

        function toggleFavorite(item) {
          const existingIndex = favorites.findIndex(f => f.name === item.name);
          if (existingIndex === -1) {
            favorites.push({ ...item });
          } else {
            favorites.splice(existingIndex, 1);
          }
          localStorage.setItem('favorites', JSON.stringify(favorites));
          updateHistoryList(document.getElementById('historyCountryFilter').value);
        }

        function showLocationFromHistory(index) {
          const item = history[index];
          showLocation(item);
        }

        function showLocationFromFavorites(index) {
          const item = favorites[index];
          showLocation(item);
        }

        function showLocation(item) {
          clearMarkers();
          const marker = L.marker(item.latlng).addTo(map);
          markers.push(marker);
          marker.bindPopup(item.name);
          marker.on('click', function() { marker.openPopup(); highlightTableRowForLocation(item); });
          map.setView(item.latlng, 15);
          updateCoordinates(item.latlng);
        }

        function updateCoordinates(latlng) {
          coordinatesDiv.textContent = `ç·¯åº¦: ${latlng.lat.toFixed(6)}, ç¶“åº¦: ${latlng.lng.toFixed(6)}`;
        }

        function clearMarkers() {
          markers.forEach(marker => map.removeLayer(marker));
          markers = [];
        }

        // ç¶²çµ¡äº‹ä»¶ç›£è½
        window.addEventListener('online', () => {
          isOnline = true;
          updateNetworkStatus();
        });

        window.addEventListener('offline', () => {
          isOnline = false;
          updateNetworkStatus();
        });

        // åˆå§‹åŒ–
        updateNetworkStatus();
        updateHistoryList();
        updateFavoritesList();

        // ä¿ç•™å…¶ä»–å¿…è¦çš„å‡½æ•¸...
        function importCSV(input) {
          const file = input.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
              try {
                const content = e.target.result;
                const lines = content.split('\n');
                const queries = lines.slice(1).map(line => {
                  const parts = line.split(',');
                  return parts[0] ? parts[0].trim() : '';
                }).filter(q => q !== '');
                
                if (queries.length === 0) {
                  alert('CSV æ–‡ä»¶ä¸­æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„åœ°å€æ•¸æ“š');
                  return;
                }
                
                document.getElementById('fileName').textContent = `å·²åŒ¯å…¥æª”æ¡ˆ: ${file.name} (${queries.length} å€‹åœ°å€)`;
                
                const csvContent = document.getElementById('csvContent').getElementsByTagName('tbody')[0];
                csvContent.innerHTML = '';
                queries.forEach(query => {
                  const row = csvContent.insertRow();
                  row.insertCell(0).textContent = query;
                });
                
                const countryCode = document.getElementById('countrySelect').value;
                document.getElementById('locations').value = queries.join('\n');
                searchLocations();
              } catch (error) {
                console.error('è®€å– CSV æ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                alert('è®€å– CSV æ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
              }
            };
            reader.onerror = function() {
              alert('è®€å–æ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤');
            };
            reader.readAsText(file);
          }
        }

        function clearImportedData() {
          document.getElementById('fileName').textContent = '';
          document.getElementById('csvContent').getElementsByTagName('tbody')[0].innerHTML = '';
          document.getElementById('csvFile').value = '';
        }

        // å…¶ä»–å¿…è¦çš„å‡½æ•¸...
        function deleteSelectedHistory() {
          const checkboxes = document.querySelectorAll('.history-checkbox:checked');
          const indicesToDelete = Array.from(checkboxes).map(checkbox => 
            parseInt(checkbox.parentElement.nextElementSibling.textContent) - 1
          ).sort((a, b) => b - a);

          indicesToDelete.forEach(index => {
            history.splice(index, 1);
          });

          localStorage.setItem('searchHistory', JSON.stringify(history));
          updateHistoryList();
          clearMarkers();
        }

        function clearAllHistory() {
          history = [];
          localStorage.removeItem('searchHistory');
          updateHistoryList();
          clearMarkers();
        }

        // ä¿®æ”¹ toggleAllCheckboxes
        function toggleAllCheckboxes() {
          const selectAll = document.getElementById('selectAll');
          const checkboxes = document.querySelectorAll('.history-checkbox');
          checkboxes.forEach((checkbox, idx) => {
            checkbox.checked = selectAll.checked;
            // è§¸ç™¼ change äº‹ä»¶ï¼Œè®“åœ°åœ–æ¨™è¨˜è‡ªå‹•é¡¯ç¤º/ç§»é™¤
            checkbox.dispatchEvent(new Event('change'));
          });
        }

        // ä¿®æ”¹ toggleAllFavoritesCheckboxes
        function toggleAllFavoritesCheckboxes() {
          const selectAllFavorites = document.getElementById('selectAllFavorites');
          const checkboxes = document.querySelectorAll('.favorite-checkbox');
          checkboxes.forEach((checkbox, idx) => {
            checkbox.checked = selectAllFavorites.checked;
            checkbox.dispatchEvent(new Event('change'));
          });
        }

        // æ–°å¢ï¼šé¡¯ç¤ºæ‰€æœ‰é¸ä¸­çš„æ­·å²è¨˜éŒ„åœ°é»
        function showSelectedHistoryLocations() {
          const checkboxes = document.querySelectorAll('.history-checkbox:checked');
          if (checkboxes.length === 0) {
            alert('è«‹å…ˆé¸æ“‡è¦é¡¯ç¤ºçš„æ­·å²è¨˜éŒ„é …ç›®');
            return;
          }
          
          clearMarkers();
          const bounds = L.latLngBounds();
          
          checkboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const index = parseInt(row.cells[1].textContent) - 1;
            const item = history[index];
            
            const marker = L.marker(item.latlng).addTo(map);
            markers.push(marker);
            marker.bindPopup(`${index + 1}. ${item.name}`);
            marker.on('click', function() { marker.openPopup(); highlightTableRowForLocation(item); });
            bounds.extend(item.latlng);
          });
          
          if (markers.length > 0) {
            map.fitBounds(bounds);
          }
        }

        // æ–°å¢ï¼šé¡¯ç¤ºæ‰€æœ‰é¸ä¸­çš„æœ€æ„›åœ°é»
        function showSelectedFavoriteLocations() {
          const checkboxes = document.querySelectorAll('.favorite-checkbox:checked');
          if (checkboxes.length === 0) {
            alert('è«‹å…ˆé¸æ“‡è¦é¡¯ç¤ºçš„æœ€æ„›é …ç›®');
            return;
          }
          
          clearMarkers();
          const bounds = L.latLngBounds();
          
          checkboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const index = parseInt(row.cells[1].textContent) - 1;
            const item = favorites[index];
            
            const marker = L.marker(item.latlng).addTo(map);
            markers.push(marker);
            marker.bindPopup(`${index + 1}. ${item.name}`);
            marker.on('click', function() { marker.openPopup(); highlightTableRowForLocation(item); });
            bounds.extend(item.latlng);
          });
          
          if (markers.length > 0) {
            map.fitBounds(bounds);
          }
        }

        // æ–°å¢ï¼šåŒ¯å‡ºæ­·å²è¨˜éŒ„ç‚ºCSV
        function exportHistoryToCSV() {
          if (history.length === 0) {
            alert('æ²’æœ‰æ­·å²è¨˜éŒ„å¯ä»¥åŒ¯å‡º');
            return;
          }
          
          const csvContent = "data:text/csv;charset=utf-8," 
            + "Name,Latitude,Longitude,Country,OriginalQuery\n"
            + history.map(h => `"${h.name}",${h.latlng.lat},${h.latlng.lng},${countryNames[h.countryCode] || ''},"${h.originalQuery || ''}"`).join("\n");
          
          const encodedUri = encodeURI(csvContent);
          const link = document.createElement("a");
          link.setAttribute("href", encodedUri);
          link.setAttribute("download", "search_history.csv");
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }

        function toggleEditMode() {
          editMode = !editMode;
          const editModeBtn = document.getElementById('editModeBtn');
          const editInstructions = document.getElementById('editInstructions');
          const editActions = document.getElementById('editActions');
          if (editMode) {
            editModeBtn.textContent = 'é€€å‡ºç·¨è¼¯æ¨¡å¼';
            editModeBtn.style.backgroundColor = '#ff4d4d';
            editInstructions.style.display = 'block';
            editActions.style.display = 'block';
            map.on('click', updateLocationOnMap);
          } else {
            editModeBtn.textContent = 'ç·¨è¼¯æ¨¡å¼';
            editModeBtn.style.backgroundColor = '#4CAF50';
            editInstructions.style.display = 'none';
            editActions.style.display = 'none';
            map.off('click', updateLocationOnMap);
            selectedHistoryIndex = -1;
            selectedFavoriteIndex = -1;
            clearMarkers();
            updateHistoryList();
            updateFavoritesList();
          }
        }

        function selectHistoryItem(index, row) {
          if (selectedHistoryIndex !== -1) {
            const prevSelectedRow = document.querySelector(`#historyList tbody tr:nth-child(${selectedHistoryIndex + 1})`);
            if (prevSelectedRow) {
              prevSelectedRow.classList.remove('edit-mode');
            }
          }
          selectedHistoryIndex = index;
          selectedFavoriteIndex = -1;
          row.classList.add('edit-mode');
          showLocationFromHistory(index);
          originalLocation = {...history[index].latlng};
        }

        function selectFavoriteItem(index, row) {
          if (selectedFavoriteIndex !== -1) {
            const prevSelectedRow = document.querySelector(`#favoritesList tbody tr:nth-child(${selectedFavoriteIndex + 1})`);
            if (prevSelectedRow) {
              prevSelectedRow.classList.remove('edit-mode');
            }
          }
          selectedFavoriteIndex = index;
          selectedHistoryIndex = -1;
          row.classList.add('edit-mode');
          showLocationFromFavorites(index);
          originalLocation = {...favorites[index].latlng};
        }

        function updateLocationOnMap(e) {
          if (selectedHistoryIndex !== -1 || selectedFavoriteIndex !== -1) {
            const newLatLng = e.latlng;
            if (tempMarker) {
              map.removeLayer(tempMarker);
            }
            tempMarker = L.marker(newLatLng).addTo(map);
            tempMarker.bindPopup(`æ–°ä½ç½®: ${newLatLng.lat.toFixed(6)}, ${newLatLng.lng.toFixed(6)}`).openPopup();
            updateCoordinates(newLatLng);
          }
        }

        function confirmEdit() {
          if (selectedHistoryIndex !== -1 && tempMarker) {
            const newLatLng = tempMarker.getLatLng();
            history[selectedHistoryIndex].latlng = newLatLng;
            const favoriteIndex = favorites.findIndex(f => f.name === history[selectedHistoryIndex].name);
            if (favoriteIndex !== -1) {
              favorites[favoriteIndex].latlng = newLatLng;
            }
            localStorage.setItem('searchHistory', JSON.stringify(history));
            localStorage.setItem('favorites', JSON.stringify(favorites));
            updateHistoryList();
            updateFavoritesList();
            clearMarkers();
            const marker = L.marker(newLatLng).addTo(map);
            markers.push(marker);
            marker.bindPopup(history[selectedHistoryIndex].name).openPopup();
            updateCoordinates(newLatLng);
            map.removeLayer(tempMarker);
            tempMarker = null;
          } else if (selectedFavoriteIndex !== -1 && tempMarker) {
            const newLatLng = tempMarker.getLatLng();
            favorites[selectedFavoriteIndex].latlng = newLatLng;
            const historyIndex = history.findIndex(h => h.name === favorites[selectedFavoriteIndex].name);
            if (historyIndex !== -1) {
              history[historyIndex].latlng = newLatLng;
            }
            localStorage.setItem('favorites', JSON.stringify(favorites));
            localStorage.setItem('searchHistory', JSON.stringify(history));
            updateFavoritesList();
            updateHistoryList();
            clearMarkers();
            const marker = L.marker(newLatLng).addTo(map);
            markers.push(marker);
            marker.bindPopup(favorites[selectedFavoriteIndex].name).openPopup();
            updateCoordinates(newLatLng);
            map.removeLayer(tempMarker);
            tempMarker = null;
          }
        }

        function cancelEdit() {
          if (selectedHistoryIndex !== -1) {
            if (tempMarker) {
              map.removeLayer(tempMarker);
              tempMarker = null;
            }
            showLocationFromHistory(selectedHistoryIndex);
          } else if (selectedFavoriteIndex !== -1) {
            if (tempMarker) {
              map.removeLayer(tempMarker);
              tempMarker = null;
            }
            showLocationFromFavorites(selectedFavoriteIndex);
          }
          updateCoordinates(originalLocation);
        }

        function filterHistoryByCountry() {
          const filter = document.getElementById('historyCountryFilter').value;
          updateHistoryList(filter);
        }

        function filterFavoritesByCountry() {
          const filter = document.getElementById('favoritesCountryFilter').value;
          updateFavoritesList(filter);
        }

        function deleteSelectedFavorites() {
          const checkboxes = document.querySelectorAll('.favorite-checkbox:checked');
          const indicesToDelete = Array.from(checkboxes).map(checkbox => 
            parseInt(checkbox.parentElement.nextElementSibling.textContent) - 1
          ).sort((a, b) => b - a);

          indicesToDelete.forEach(index => {
            favorites.splice(index, 1);
          });

          localStorage.setItem('favorites', JSON.stringify(favorites));
          updateFavoritesList();
          updateHistoryList();
          clearMarkers();
        }

        function clearAllFavorites() {
          favorites = [];
          localStorage.removeItem('favorites');
          updateFavoritesList();
          updateHistoryList();
          clearMarkers();
        }

        function exportFavoritesToCSV() {
          const csvContent = "data:text/csv;charset=utf-8," 
            + "Name,Latitude,Longitude,Country,OriginalQuery\n"
            + favorites.map(f => `"${f.name}",${f.latlng.lat},${f.latlng.lng},${countryNames[f.countryCode] || ''},"${f.originalQuery || ''}"`).join("\n");
          
          const encodedUri = encodeURI(csvContent);
          const link = document.createElement("a");
          link.setAttribute("href", encodedUri);
          link.setAttribute("download", "favorites.csv");
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }

        function toggleSidebar() {
          const sidebar = document.getElementById('sidebar');
          const toggleBtn = document.getElementById('toggleSidebar');
          const coordinatesDiv = document.getElementById('coordinates');

          sidebarVisible = !sidebarVisible;
          
          if (sidebarVisible) {
            sidebar.style.width = '400px';
            toggleBtn.style.left = '410px';
            toggleBtn.textContent = 'éš±è—å´æ¬„';
            coordinatesDiv.style.left = '420px';
            map.invalidateSize();
          } else {
            sidebar.style.width = '0';
            toggleBtn.style.left = '10px';
            toggleBtn.textContent = 'é¡¯ç¤ºå´æ¬„';
            coordinatesDiv.style.left = '20px';
            map.invalidateSize();
          }
        }

        // æ·»åŠ  resize åŠŸèƒ½
        const resizer = document.getElementById('resizer');
        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
          isResizing = true;
          document.addEventListener('mousemove', resize);
          document.addEventListener('mouseup', stopResize);
        });

        function resize(e) {
          if (isResizing) {
            const sidebar = document.getElementById('sidebar');
            const newWidth = e.clientX - sidebar.getBoundingClientRect().left;
            if (newWidth > 200 && newWidth < window.innerWidth - 200) {
              sidebar.style.width = newWidth + 'px';
              document.getElementById('toggleSidebar').style.left = (newWidth + 10) + 'px';
              document.getElementById('coordinates').style.left = (newWidth + 20) + 'px';
              map.invalidateSize();
            }
          }
        }

        function stopResize() {
          isResizing = false;
          document.removeEventListener('mousemove', resize);
          document.removeEventListener('mouseup', stopResize);
        }

        map.on('mousemove', (e) => {
          updateCoordinates(e.latlng);
        });

        // é é¢åŠ è¼‰æ™‚åˆå§‹åŒ–
        window.onload = function() {
          updateHistoryList();
          updateFavoritesList();
          
          // åˆå§‹åŒ–æ‰€æœ‰å€å¡Šç‚ºå±•é–‹ç‹€æ…‹
          document.querySelectorAll('.section-content').forEach(content => {
            content.classList.add('active');
          });
        };

        function addAllHistoryToFavorites() {
          let added = 0;
          history.forEach(item => {
            if (!favorites.some(f => f.name === item.name)) {
              favorites.push({ ...item });
              added++;
            }
          });
          if (added > 0) {
            localStorage.setItem('favorites', JSON.stringify(favorites));
            updateFavoritesList();
            updateHistoryList();
            alert('å·²å°‡æ‰€æœ‰æ­·å²åŠ å…¥æœ€æ„›');
          } else {
            alert('æ‰€æœ‰æ­·å²éƒ½å·²åœ¨æœ€æ„›ä¸­');
          }
        }

        // æ–°å¢ï¼šåœ°åœ–é»æ“Šæ–°å¢åœ°é»åŠŸèƒ½
        function enableAddLocationMode() {
          addLocationMode = !addLocationMode;
          const addLocationBtn = document.getElementById('addLocationBtn');
          if (addLocationMode) {
            addLocationBtn.textContent = 'é€€å‡ºæ–°å¢æ¨¡å¼';
            addLocationBtn.style.backgroundColor = '#ff4d4d';
            map.on('mousemove', moveFloatingAddMarker);
            map.on('click', handleMapClickForAdd);
            if (!floatingAddMarker) {
              floatingAddMarker = L.marker(map.getCenter(), { draggable: false, opacity: 0.7, interactive: false }).addTo(map);
            }
          } else {
            addLocationBtn.textContent = 'æ–°å¢åœ°é»æ¨¡å¼';
            addLocationBtn.style.backgroundColor = '#4CAF50';
            map.off('mousemove', moveFloatingAddMarker);
            map.off('click', handleMapClickForAdd);
            if (floatingAddMarker) {
              map.removeLayer(floatingAddMarker);
              floatingAddMarker = null;
            }
          }
        }

        function moveFloatingAddMarker(e) {
          if (addLocationMode && floatingAddMarker) {
            floatingAddMarker.setLatLng(e.latlng);
          }
        }

        function handleMapClickForAdd(e) {
          if (!addLocationMode) return;
          const latlng = e.latlng;
          if (floatingAddMarker) {
            floatingAddMarker.setLatLng(latlng);
          }
          const locationName = prompt('è«‹è¼¸å…¥åœ°é»åç¨±ï¼š');
          if (locationName && locationName.trim() !== '') {
            const newLocation = {
              name: locationName.trim(),
              latlng: latlng,
              countryCode: '',
              originalQuery: locationName.trim() // æ–°å¢åœ°é»æ™‚ï¼ŒåŸå§‹è³‡æ–™å°±æ˜¯åœ°é»åç¨±
            };
            history.unshift(newLocation);
            localStorage.setItem('searchHistory', JSON.stringify(history));
            updateHistoryList();
            // åœ¨åœ°åœ–ä¸Šé¡¯ç¤ºæ¨™è¨˜
            const marker = L.marker(latlng).addTo(map);
            markers.push(marker);
            marker.bindPopup(newLocation.name);
            marker.on('click', function() { marker.openPopup(); highlightTableRowForLocation(newLocation); });
            map.setView(latlng, 15);
            updateCoordinates(latlng);
            alert(`å·²æ–°å¢åœ°é»ï¼š${locationName}`);
          }
          // ç§»é™¤æµ®å‹• markerï¼Œé€€å‡ºæ–°å¢æ¨¡å¼
          if (floatingAddMarker) {
            map.removeLayer(floatingAddMarker);
            floatingAddMarker = null;
          }
          addLocationMode = false;
          const addLocationBtn = document.getElementById('addLocationBtn');
          addLocationBtn.textContent = 'æ–°å¢åœ°é»æ¨¡å¼';
          addLocationBtn.style.backgroundColor = '#4CAF50';
          map.off('mousemove', moveFloatingAddMarker);
          map.off('click', handleMapClickForAdd);
        }

        // æ–°å¢ï¼šåœ¨åœ°åœ–ä¸Šé¡¯ç¤ºæ‰€æœ‰æ­·å²åœ°é»
        function showAllHistoryOnMap() {
          clearMarkers();
          const bounds = L.latLngBounds();
          
          history.forEach((item, index) => {
            const marker = L.marker(item.latlng).addTo(map);
            markers.push(marker);
            marker.bindPopup(`${index + 1}. ${item.name}`);
            marker.on('click', function() { marker.openPopup(); highlightTableRowForLocation(item); });
            bounds.extend(item.latlng);
          });
          
          if (markers.length > 0) {
            map.fitBounds(bounds);
          }
        }

        // æ–°å¢ï¼šåœ¨åœ°åœ–ä¸Šé¡¯ç¤ºæ‰€æœ‰æœ€æ„›åœ°é»
        function showAllFavoritesOnMap() {
          clearMarkers();
          const bounds = L.latLngBounds();
          
          favorites.forEach((item, index) => {
            const marker = L.marker(item.latlng).addTo(map);
            markers.push(marker);
            marker.bindPopup(`${index + 1}. ${item.name}`);
            marker.on('click', function() { marker.openPopup(); highlightTableRowForLocation(item); });
            bounds.extend(item.latlng);
          });
          
          if (markers.length > 0) {
            map.fitBounds(bounds);
          }
        }

        // æ–°å¢ï¼šæ”¶åˆ/å±•é–‹åŠŸèƒ½
        function toggleSection(sectionId) {
          const section = document.getElementById(sectionId);
          const toggleBtn = section.querySelector('.toggle-btn');
          const sectionContent = section.querySelector('.section-content');

          if (sectionContent.classList.contains('active')) {
            sectionContent.classList.remove('active');
            toggleBtn.textContent = '[+]';
          } else {
            sectionContent.classList.add('active');
            toggleBtn.textContent = '[-]';
          }
        }

        // è·é›¢æ¸¬é‡ä¿®æ­£
        function enableDistanceMode(forceOff = null) {
          if (forceOff === true) distanceMode = false;
          else if (forceOff === false) distanceMode = true;
          else distanceMode = !distanceMode;
          const distanceBtn = document.getElementById('distanceBtn');
          if (!distanceMode) {
            distanceBtn.textContent = 'è·é›¢æ¸¬é‡æ¨¡å¼';
            distanceBtn.style.backgroundColor = '#4CAF50';
            map.off('click', handleMapClickForDistance);
            map.off('mousemove', moveFloatingDistanceLine);
            clearDistanceMeasurement();
          } else {
            distanceBtn.textContent = 'é€€å‡ºæ¸¬é‡æ¨¡å¼';
            distanceBtn.style.backgroundColor = '#ff4d4d';
            map.on('click', handleMapClickForDistance);
            map.on('mousemove', moveFloatingDistanceLine);
            clearDistanceMeasurement();
          }
        }

        // è·é›¢æ¸¬é‡ï¼šç§»é™¤2ç§’è‡ªå‹•é€€å‡º
        function handleMapClickForDistance(e) {
          if (!distanceMode) return;
          const latlng = e.latlng;
          if (!distanceStartLatLng) {
            // è¨­å®šèµ·é»
            distanceStartLatLng = latlng;
            const marker = L.marker(latlng).addTo(map);
            distanceMarkers.push(marker);
            marker.bindPopup('èµ·é»');
            marker.on('click', function() { marker.openPopup(); });
          } else {
            // çµ‚é»
            const marker = L.marker(latlng).addTo(map);
            distanceMarkers.push(marker);
            marker.bindPopup('çµ‚é»');
            marker.on('click', function() { marker.openPopup(); });
            // ç•«æœ€çµ‚ç·šæ¢
            distancePolyline = L.polyline([distanceStartLatLng, latlng], {
              color: 'red',
              weight: 3,
              opacity: 0.7
            }).addTo(map);
            // é¡¯ç¤ºè·é›¢æ¨™ç±¤ï¼ˆå°å­—ï¼Œç„¡ç´…æ¡†ç™½åº•ï¼‰
            const distance = calculateDistance(distanceStartLatLng, latlng);
            const midPoint = L.latLng(
              (distanceStartLatLng.lat + latlng.lat) / 2,
              (distanceStartLatLng.lng + latlng.lng) / 2
            );
            floatingDistanceLabel = L.marker(midPoint, {
              icon: L.divIcon({
                className: 'distance-label',
                html: `<div style=\"background: none; color: #d00; font-size: 13px; font-weight: bold;\">${distance}</div>`,
                iconSize: [80, 18],
                iconAnchor: [40, 9]
              })
            }).addTo(map);
            // ä¸å†è‡ªå‹•é€€å‡ºï¼Œéœ€æ‰‹å‹•é»æ“Šé€€å‡º
          }
        }

        function moveFloatingDistanceLine(e) {
          if (!distanceMode) return;
          if (distanceStartLatLng) {
            const endLatLng = e.latlng;
            // ç•«æµ®å‹•ç·šæ¢
            if (floatingDistanceLine) {
              floatingDistanceLine.setLatLngs([distanceStartLatLng, endLatLng]);
            } else {
              floatingDistanceLine = L.polyline([distanceStartLatLng, endLatLng], {
                color: 'orange',
                weight: 2,
                dashArray: '5, 5',
                opacity: 0.7
              }).addTo(map);
            }
            // è¨ˆç®—è·é›¢ä¸¦é¡¯ç¤ºæµ®å‹•æ¨™ç±¤ï¼ˆå°å­—ï¼‰
            const distance = calculateDistance(distanceStartLatLng, endLatLng);
            const midPoint = L.latLng(
              (distanceStartLatLng.lat + endLatLng.lat) / 2,
              (distanceStartLatLng.lng + endLatLng.lng) / 2
            );
            if (floatingDistanceLabel) {
              floatingDistanceLabel.setLatLng(midPoint);
              floatingDistanceLabel.setIcon(L.divIcon({
                className: 'distance-label',
                html: `<div style=\"background: none; color: #d00; font-size: 13px; font-weight: bold;\">${distance}</div>`,
                iconSize: [80, 18],
                iconAnchor: [40, 9]
              }));
            } else {
              floatingDistanceLabel = L.marker(midPoint, {
                icon: L.divIcon({
                  className: 'distance-label',
                  html: `<div style=\"background: none; color: #d00; font-size: 13px; font-weight: bold;\">${distance}</div>`,
                  iconSize: [80, 18],
                  iconAnchor: [40, 9]
                })
              }).addTo(map);
            }
          }
        }

        function clearDistanceMeasurement() {
          distanceMarkers.forEach(marker => map.removeLayer(marker));
          distanceMarkers = [];
          if (distancePolyline) {
            map.removeLayer(distancePolyline);
            distancePolyline = null;
          }
          if (floatingDistanceLine) {
            map.removeLayer(floatingDistanceLine);
            floatingDistanceLine = null;
          }
          if (floatingDistanceLabel) {
            map.removeLayer(floatingDistanceLabel);
            floatingDistanceLabel = null;
          }
          distanceStartLatLng = null;
        }

        function calculateDistance(latLng1, latLng2) {
          const R = 6371; // åœ°çƒåŠå¾‘ï¼ˆå…¬é‡Œï¼‰
          const dLat = (latLng2.lat - latLng1.lat) * Math.PI / 180;
          const dLng = (latLng2.lng - latLng1.lng) * Math.PI / 180;
          const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(latLng1.lat * Math.PI / 180) * Math.cos(latLng2.lat * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
          const distance = R * c;
          
          if (distance < 1) {
            return `${(distance * 1000).toFixed(0)} å…¬å°º`;
          } else {
            return `${distance.toFixed(2)} å…¬é‡Œ`;
          }
        }

        // ç¯„åœæœå°‹ä¿®æ­£
        function enableRangeSearchMode() {
          rangeSearchMode = !rangeSearchMode;
          const rangeSearchBtn = document.getElementById('rangeSearchBtn');
          clearRangeSearch();
          if (rangeSearchMode) {
            rangeSearchBtn.textContent = 'é€€å‡ºç¯„åœæœå°‹';
            rangeSearchBtn.style.backgroundColor = '#ff4d4d';
            rangeStep = 0;
            map.on('click', handleMapClickForRangeSearch);
            map.on('mousemove', moveFloatingRangeCircle);
          } else {
            rangeSearchBtn.textContent = 'ç¯„åœæœå°‹æ¨¡å¼';
            rangeSearchBtn.style.backgroundColor = '#4CAF50';
            map.off('click', handleMapClickForRangeSearch);
            map.off('mousemove', moveFloatingRangeCircle);
            clearRangeSearch();
          }
        }

        // ç¯„åœæœå°‹ï¼šé»æ“Šç¬¬ä¸€é»æ™‚ç«‹å³é¡¯ç¤ºä¸­å¿ƒé»æ¨™è¨˜
        function handleMapClickForRangeSearch(e) {
          if (!rangeSearchMode) return;
          const latlng = e.latlng;
          if (rangeStep === 0) {
            // é¸æ“‡ä¸­å¿ƒé»
            rangeCenter = latlng;
            rangeStep = 1;
            // ç«‹å³é¡¯ç¤ºä¸­å¿ƒé»æ¨™è¨˜ï¼ˆå¼·åˆ¶åˆ·æ–°ï¼‰
            if (rangeCenterMarker) {
              map.removeLayer(rangeCenterMarker);
              rangeCenterMarker = null;
            }
            rangeCenterMarker = L.marker(latlng).addTo(map);
            rangeCenterMarker.bindPopup('ä¸­å¿ƒé»');
            rangeCenterMarker.on('click', function() { rangeCenterMarker.openPopup(); });
            map.setView(latlng, map.getZoom()); // å¼·åˆ¶åˆ·æ–°åœ°åœ–
          } else if (rangeStep === 1) {
            // é¸æ“‡åŠå¾‘
            const radiusKm = calculateDistanceInKm(rangeCenter, latlng);
            if (floatingRangeCircle) {
              map.removeLayer(floatingRangeCircle);
              floatingRangeCircle = null;
            }
            if (floatingRangeLabel) {
              map.removeLayer(floatingRangeLabel);
              floatingRangeLabel = null;
            }
            if (rangeCenterMarker) {
              map.removeLayer(rangeCenterMarker);
              rangeCenterMarker = null;
            }
            rangeCircle = L.circle(rangeCenter, {
              color: 'blue',
              fillColor: '#30f',
              fillOpacity: 0.2,
              radius: radiusKm * 1000
            }).addTo(map);
            searchLocationsInRange(rangeCenter, radiusKm);
            // é‡ç½®ç‹€æ…‹
            rangeStep = 0;
            rangeSearchMode = false;
            const rangeSearchBtn = document.getElementById('rangeSearchBtn');
            rangeSearchBtn.textContent = 'ç¯„åœæœå°‹æ¨¡å¼';
            rangeSearchBtn.style.backgroundColor = '#4CAF50';
            map.off('click', handleMapClickForRangeSearch);
            map.off('mousemove', moveFloatingRangeCircle);
          }
        }

        function moveFloatingRangeCircle(e) {
          if (!rangeSearchMode || rangeStep !== 1) return;
          const mouseLatLng = e.latlng;
          const radiusKm = calculateDistanceInKm(rangeCenter, mouseLatLng);
          // ç•«æµ®å‹•åœ“å½¢
          if (floatingRangeCircle) {
            floatingRangeCircle.setRadius(radiusKm * 1000);
          } else {
            floatingRangeCircle = L.circle(rangeCenter, {
              color: 'blue',
              fillColor: '#30f',
              fillOpacity: 0.1,
              radius: radiusKm * 1000,
              interactive: false
            }).addTo(map);
          }
          // é¡¯ç¤ºæµ®å‹•åŠå¾‘æ¨™ç±¤ï¼ˆå°å­—ï¼‰
          const midPoint = L.latLng(
            (rangeCenter.lat + mouseLatLng.lat) / 2,
            (rangeCenter.lng + mouseLatLng.lng) / 2
          );
          const labelText = `åŠå¾‘: ${radiusKm.toFixed(2)} å…¬é‡Œ`;
          if (floatingRangeLabel) {
            floatingRangeLabel.setLatLng(midPoint);
            floatingRangeLabel.setIcon(L.divIcon({
              className: 'distance-label',
              html: `<div style=\"background: none; color: #06c; font-size: 13px; font-weight: bold;\">${labelText}</div>`,
              iconSize: [100, 18],
              iconAnchor: [50, 9]
            }));
          } else {
            floatingRangeLabel = L.marker(midPoint, {
              icon: L.divIcon({
                className: 'distance-label',
                html: `<div style=\"background: none; color: #06c; font-size: 13px; font-weight: bold;\">${labelText}</div>`,
                iconSize: [100, 18],
                iconAnchor: [50, 9]
              })
            }).addTo(map);
          }
        }

        function clearRangeSearch() {
          if (rangeCircle) {
            map.removeLayer(rangeCircle);
            rangeCircle = null;
          }
          if (floatingRangeCircle) {
            map.removeLayer(floatingRangeCircle);
            floatingRangeCircle = null;
          }
          if (floatingRangeLabel) {
            map.removeLayer(floatingRangeLabel);
            floatingRangeLabel = null;
          }
          if (rangeCenterMarker) {
            map.removeLayer(rangeCenterMarker);
            rangeCenterMarker = null;
          }
          rangeCenter = null;
          rangeStep = 0;
        }

        function searchLocationsInRange(center, radiusKm) {
          const locationsInRange = [];
          
          // æœå°‹æ­·å²è¨˜éŒ„
          history.forEach((item, index) => {
            const distance = calculateDistanceInKm(center, item.latlng);
            if (distance <= radiusKm) {
              locationsInRange.push({
                ...item,
                distance: distance,
                type: 'history',
                index: index
              });
            }
          });
          
          // æœå°‹æœ€æ„›
          favorites.forEach((item, index) => {
            const distance = calculateDistanceInKm(center, item.latlng);
            if (distance <= radiusKm) {
              locationsInRange.push({
                ...item,
                distance: distance,
                type: 'favorite',
                index: index
              });
            }
          });
          
          // é¡¯ç¤ºçµæœ
          showRangeSearchResults(locationsInRange, center, radiusKm);
        }

        function calculateDistanceInKm(latLng1, latLng2) {
          const R = 6371; // åœ°çƒåŠå¾‘ï¼ˆå…¬é‡Œï¼‰
          const dLat = (latLng2.lat - latLng1.lat) * Math.PI / 180;
          const dLng = (latLng2.lng - latLng1.lng) * Math.PI / 180;
          const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(latLng1.lat * Math.PI / 180) * Math.cos(latLng2.lat * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
          return R * c;
        }

        function showRangeSearchResults(locations, center, radius) {
          clearMarkers();
          
          if (locations.length === 0) {
            alert(`åœ¨ ${radius} å…¬é‡Œç¯„åœå…§æ²’æœ‰æ‰¾åˆ°ä»»ä½•åœ°é»`);
            return;
          }
          
          // åœ¨åœ°åœ–ä¸Šé¡¯ç¤ºæ‰€æœ‰ç¯„åœå…§çš„åœ°é»
          const bounds = L.latLngBounds();
          let names = [];
          locations.forEach((location, index) => {
            const marker = L.marker(location.latlng).addTo(map);
            markers.push(marker);
            
            const popupContent = `${index + 1}. ${location.name}<br>è·é›¢: ${location.distance.toFixed(2)} å…¬é‡Œ<br>é¡å‹: ${location.type === 'history' ? 'æ­·å²' : 'æœ€æ„›'}<br>åŸå§‹è³‡æ–™: ${location.originalQuery || '-'}`;
            marker.bindPopup(popupContent);
            marker.on('click', function() { marker.openPopup(); highlightTableRowForLocation(location); });
            bounds.extend(location.latlng);
            names.push(`${index + 1}. ${location.name}`);
          });
          
          // èª¿æ•´åœ°åœ–è¦–çª—
          map.fitBounds(bounds);
          
          // é¡¯ç¤ºçµæœæ‘˜è¦
          const historyCount = locations.filter(l => l.type === 'history').length;
          const favoriteCount = locations.filter(l => l.type === 'favorite').length;
          
          alert(`åœ¨ ${radius} å…¬é‡Œç¯„åœå…§æ‰¾åˆ° ${locations.length} å€‹åœ°é»ï¼š\næ­·å²è¨˜éŒ„: ${historyCount} å€‹\næˆ‘çš„æœ€æ„›: ${favoriteCount} å€‹\nåœ°é»åç¨±ï¼š\n${names.join('\n')}`);
        }

        function highlightTableRowForLocation(item) {
          // æŸ¥è©¢æ­·å²
          const historyRows = document.querySelectorAll('#historyList tbody tr');
          historyRows.forEach(row => {
            const lat = parseFloat(row.cells[3].textContent);
            const lng = parseFloat(row.cells[4].textContent);
            const mapIcon = row.querySelector('span');
            if (lat === item.latlng.lat && lng === item.latlng.lng && mapIcon) {
              mapIcon.classList.add('distance-map-highlight');
              row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else if (mapIcon) {
              mapIcon.classList.remove('distance-map-highlight');
            }
          });
          // æˆ‘çš„æœ€æ„›
          const favRows = document.querySelectorAll('#favoritesList tbody tr');
          favRows.forEach(row => {
            const lat = parseFloat(row.cells[3].textContent);
            const lng = parseFloat(row.cells[4].textContent);
            const mapIcon = row.querySelector('span');
            if (lat === item.latlng.lat && lng === item.latlng.lng && mapIcon) {
              mapIcon.classList.add('distance-map-highlight');
              row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else if (mapIcon) {
              mapIcon.classList.remove('distance-map-highlight');
            }
          });
        }
      </script>
    </body>
    </html> 